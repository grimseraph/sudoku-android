<!DOCTYPE html>
<html lang="zh" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•°ç‹¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€â”€ Theme Variables â”€â”€â”€ */
  :root {
    --cell-size: min(52px, 10vw);
    --transition-theme: background 0.3s, color 0.3s, border-color 0.3s;
  }

  [data-theme="dark"] {
    --bg: #0f0e17;
    --card: #22203a;
    --border: #2e2c4a;
    --accent: #e8a020;
    --accent2: #7c6fff;
    --text: #f0eeff;
    --text-muted: #8a88aa;
    --given: #c8c0ff;
    --error: #ff6b6b;
    --cell-bg: #0f0e17;
    --cell-hover: rgba(124,111,255,0.12);
    --cell-selected: rgba(124,111,255,0.22);
    --cell-highlighted: rgba(124,111,255,0.08);
    --cell-same: rgba(232,160,32,0.12);
    --board-glow: 0 0 40px rgba(232,160,32,0.15), 0 20px 60px rgba(0,0,0,0.5);
    --overlay-bg: rgba(0,0,0,0.7);
    --bg-g1: rgba(124,111,255,0.08);
    --bg-g2: rgba(232,160,32,0.06);
    --box-border: rgba(232,160,32,0.4);
    --accent-text: #0f0e17;
  }

  [data-theme="light"] {
    --bg: #f4f2ff;
    --card: #ffffff;
    --border: #ddd8f5;
    --accent: #c47a00;
    --accent2: #5b4ed4;
    --text: #1a1733;
    --text-muted: #6b68a0;
    --given: #3730a8;
    --error: #c93535;
    --cell-bg: #ffffff;
    --cell-hover: rgba(91,78,212,0.07);
    --cell-selected: rgba(91,78,212,0.15);
    --cell-highlighted: rgba(91,78,212,0.04);
    --cell-same: rgba(196,122,0,0.09);
    --board-glow: 0 0 30px rgba(196,122,0,0.08), 0 8px 32px rgba(91,78,212,0.15);
    --overlay-bg: rgba(20,18,50,0.6);
    --bg-g1: rgba(91,78,212,0.06);
    --bg-g2: rgba(196,122,0,0.04);
    --box-border: rgba(91,78,212,0.3);
    --accent-text: #ffffff;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    transition: var(--transition-theme);
  }

  body::before {
    content: '';
    position: fixed;
    top:-50%; left:-50%;
    width:200%; height:200%;
    background: radial-gradient(ellipse at 30% 20%, var(--bg-g1) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, var(--bg-g2) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€â”€ Offline Bar â”€â”€â”€ */
  #offlineBar {
    display: none;
    position: fixed;
    top:0; left:0; right:0;
    z-index: 300;
    background: var(--error);
    color: #fff;
    text-align: center;
    font-size: 0.72rem;
    padding: 7px 16px;
    letter-spacing: 0.06em;
    font-weight: 500;
    animation: slideDown 0.3s ease;
  }
  #offlineBar.show { display: block; }
  @keyframes slideDown {
    from { transform: translateY(-100%); }
    to   { transform: translateY(0); }
  }

  /* â”€â”€â”€ Save Toast â”€â”€â”€ */
  #saveToast {
    position: fixed;
    bottom: 20px; right: 16px;
    z-index: 200;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 7px 13px;
    font-size: 0.68rem;
    color: var(--text-muted);
    display: flex; align-items: center; gap: 6px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
  }
  #saveToast.show { opacity: 1; transform: translateY(0); }
  #saveToast .dot { width:6px; height:6px; border-radius:50%; background:var(--accent); flex-shrink:0; }

  /* â”€â”€â”€ Layout â”€â”€â”€ */
  .container {
    position: relative; z-index: 1;
    width: 100%; max-width: 560px;
    padding: 24px 16px 40px;
    display: flex; flex-direction: column;
    align-items: center; gap: 20px;
  }

  header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .header-left { display:flex; flex-direction:column; gap:12px; }

  .title-group h1 {
    font-family: 'Noto Serif SC', serif;
    font-size: 2.4rem; font-weight: 700;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--accent) 0%, #ffcc70 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
  }

  .title-group p {
    font-size: 0.7rem; color: var(--text-muted);
    letter-spacing: 0.15em; text-transform: uppercase;
    margin-top: 4px;
  }

  /* â”€â”€â”€ Theme Toggle â”€â”€â”€ */
  .theme-toggle {
    display: flex; gap: 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 3px;
    transition: background 0.3s, border-color 0.3s;
    align-self: flex-start;
  }

  .theme-btn {
    width: 32px; height: 28px;
    border-radius: 20px; border: none;
    background: transparent;
    font-size: 0.82rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-muted);
  }
  .theme-btn:hover { color: var(--text); }
  .theme-btn.active {
    background: var(--accent);
    color: var(--accent-text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  }

  /* â”€â”€â”€ Stats â”€â”€â”€ */
  .stats { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }

  .timer {
    font-size: 1.6rem; font-weight: 500;
    color: var(--text); letter-spacing: 0.05em;
    transition: color 0.3s;
  }

  .mistakes {
    font-size: 0.72rem; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px;
  }

  .mistake-dots { display:flex; gap:3px; }

  .mistake-dot {
    width:7px; height:7px; border-radius:50%;
    background: var(--border); transition: background 0.3s;
  }
  .mistake-dot.active { background: var(--error); }

  /* â”€â”€â”€ Difficulty â”€â”€â”€ */
  .difficulty-row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

  .diff-btn {
    padding: 6px 16px; border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent; color: var(--text-muted);
    font-family: 'DM Mono', monospace; font-size: 0.72rem;
    cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em;
  }
  .diff-btn:hover { border-color: var(--accent2); color: var(--text); }
  .diff-btn.active { background: var(--accent); border-color: var(--accent); color: var(--accent-text); font-weight: 500; }

  /* â”€â”€â”€ Progress â”€â”€â”€ */
  .progress-bar {
    width:100%; height:3px;
    background: var(--border); border-radius:2px; overflow:hidden;
    transition: background 0.3s;
  }
  .progress-fill {
    height:100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius:2px; transition: width 0.5s ease;
  }

  /* â”€â”€â”€ Board â”€â”€â”€ */
  .board {
    display: grid;
    grid-template-columns: repeat(9, var(--cell-size));
    grid-template-rows: repeat(9, var(--cell-size));
    border: 2px solid var(--accent);
    border-radius: 6px; overflow: hidden;
    box-shadow: var(--board-glow);
    transition: box-shadow 0.3s;
  }

  .cell {
    width: var(--cell-size); height: var(--cell-size);
    display: flex; align-items: center; justify-content: center;
    font-size: calc(var(--cell-size) * 0.42);
    font-family: 'DM Mono', monospace; font-weight: 500;
    cursor: pointer; position: relative;
    transition: background 0.15s, color 0.3s;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    user-select: none; -webkit-user-select: none;
    background: var(--cell-bg);
  }

  .cell:nth-child(9n)  { border-right: none; }
  .cell:nth-child(n+73){ border-bottom: none; }
  .cell[data-col="3"], .cell[data-col="6"] { border-left: 2px solid var(--box-border); }
  .cell[data-row="3"], .cell[data-row="6"] { border-top:  2px solid var(--box-border); }

  .cell:hover       { background: var(--cell-hover); }
  .cell.selected    { background: var(--cell-selected); }
  .cell.highlighted { background: var(--cell-highlighted); }
  .cell.same-number { background: var(--cell-same); }
  .cell.given       { color: var(--given); }
  .cell.user-input  { color: var(--accent2); }
  .cell.error       { color: var(--error) !important; }
  .cell.error::after {
    content:''; position:absolute; inset:2px;
    border-radius:3px; border:1px solid var(--error); opacity:0.5;
  }

  .cell.has-notes .cell-val { display:none; }
  .notes-grid {
    display:none;
    grid-template-columns: repeat(3,1fr);
    grid-template-rows: repeat(3,1fr);
    width:100%; height:100%; padding:1px;
  }
  .cell.has-notes .notes-grid { display:grid; }
  .note-num {
    display:flex; align-items:center; justify-content:center;
    font-size: calc(var(--cell-size) * 0.2);
    color: var(--text-muted);
  }
  .note-num.filled { color: var(--accent2); opacity:0.9; }

  @keyframes pulse-cell {
    0%,100% { background: rgba(74,222,128,0.15); }
    50%      { background: rgba(74,222,128,0.3); }
  }
  .cell.just-correct { animation: pulse-cell 0.4s ease; }

  /* â”€â”€â”€ Controls â”€â”€â”€ */
  .controls { display:flex; flex-direction:column; gap:12px; width:100%; }

  .numpad { display:grid; grid-template-columns:repeat(9,1fr); gap:6px; }

  .num-btn {
    aspect-ratio:1; border-radius:8px;
    border:1px solid var(--border); background:var(--card);
    color:var(--text); font-family:'DM Mono',monospace;
    font-size: clamp(0.9rem,3vw,1.2rem); font-weight:500;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; justify-content:center;
    position:relative;
  }
  .num-btn:hover  { background:var(--cell-hover); border-color:var(--accent2); }
  .num-btn:active { transform:scale(0.93); }
  .num-btn.depleted { opacity:0.25; pointer-events:none; }

  .num-count {
    position:absolute; bottom:2px; right:4px;
    font-size:0.5rem; color:var(--text-muted);
  }

  .action-row { display:flex; gap:8px; }

  .action-btn {
    flex:1; padding:10px 8px; border-radius:8px;
    border:1px solid var(--border); background:var(--card);
    color:var(--text-muted); font-family:'DM Mono',monospace;
    font-size:0.72rem; cursor:pointer; transition:all 0.2s;
    display:flex; flex-direction:column; align-items:center; gap:4px;
    letter-spacing:0.03em;
  }
  .action-btn .icon { font-size:1.1rem; }
  .action-btn:hover { border-color:var(--accent2); color:var(--text); }
  .action-btn.active { background:rgba(124,111,255,0.15); border-color:var(--accent2); color:var(--accent2); }

  /* â”€â”€â”€ Overlay â”€â”€â”€ */
  .overlay {
    position:fixed; inset:0;
    background: var(--overlay-bg);
    backdrop-filter:blur(8px);
    display:flex; align-items:center; justify-content:center;
    z-index:100; opacity:0; pointer-events:none;
    transition:opacity 0.4s;
  }
  .overlay.show { opacity:1; pointer-events:all; }

  .modal {
    background:var(--card); border:1px solid var(--border);
    border-radius:20px; padding:40px 32px; text-align:center;
    max-width:300px; width:90%;
    transform:translateY(20px); transition:transform 0.4s, background 0.3s;
    box-shadow:0 30px 80px rgba(0,0,0,0.35);
  }
  .overlay.show .modal { transform:translateY(0); }

  .modal-emoji { font-size:3rem; margin-bottom:16px; }
  .modal h2 {
    font-family:'Noto Serif SC',serif; font-size:1.6rem;
    margin-bottom:8px; color:var(--accent);
  }
  .modal p { color:var(--text-muted); font-size:0.8rem; margin-bottom:24px; line-height:1.6; }

  .modal-btn {
    padding:12px 32px; border-radius:30px; border:none;
    background:var(--accent); color:var(--accent-text);
    font-family:'DM Mono',monospace; font-size:0.85rem; font-weight:500;
    cursor:pointer; transition:all 0.2s;
  }
  .modal-btn:hover { transform:scale(1.05); }

  @keyframes float {
    0%,100% { transform:translateY(0); }
    50%      { transform:translateY(-8px); }
  }
  .overlay.show .modal-emoji { animation:float 2s ease-in-out infinite; }
</style>
</head>
<body>

<div id="offlineBar">ğŸ“µ å½“å‰ç¦»çº¿ Â· æ¸¸æˆå·²æœ¬åœ°å­˜æ¡£ï¼Œå¯æ­£å¸¸æ¸¸ç©</div>
<div id="saveToast"><div class="dot"></div>å·²è‡ªåŠ¨å­˜æ¡£</div>

<div class="container">
  <header>
    <div class="header-left">
      <div class="title-group">
        <h1>æ•°ç‹¬</h1>
        <p>SUDOKU PUZZLE</p>
      </div>
      <div class="theme-toggle">
        <button class="theme-btn" data-mode="light" title="æµ…è‰²æ¨¡å¼">â˜€ï¸</button>
        <button class="theme-btn" data-mode="system" title="è·Ÿéšç³»ç»Ÿ">ğŸŒ“</button>
        <button class="theme-btn" data-mode="dark" title="æ·±è‰²æ¨¡å¼">ğŸŒ™</button>
      </div>
    </div>
    <div class="stats">
      <div class="timer" id="timer">00:00</div>
      <div class="mistakes">é”™è¯¯
        <div class="mistake-dots" id="mistakeDots">
          <div class="mistake-dot"></div>
          <div class="mistake-dot"></div>
          <div class="mistake-dot"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="difficulty-row">
    <button class="diff-btn" data-level="easy">ç®€å•</button>
    <button class="diff-btn active" data-level="medium">ä¸­ç­‰</button>
    <button class="diff-btn" data-level="hard">å›°éš¾</button>
    <button class="diff-btn" data-level="expert">ä¸“å®¶</button>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>

  <div class="board-wrapper">
    <div class="board" id="board"></div>
  </div>

  <div class="controls">
    <div class="numpad" id="numpad"></div>
    <div class="action-row">
      <button class="action-btn" id="btnUndo"><span class="icon">â†©</span>æ’¤é”€</button>
      <button class="action-btn" id="btnErase"><span class="icon">âŒ«</span>æ¸…é™¤</button>
      <button class="action-btn" id="btnNote"><span class="icon">âœï¸</span>å¤‡æ³¨</button>
      <button class="action-btn" id="btnHint"><span class="icon">ğŸ’¡</span>æç¤º</button>
      <button class="action-btn" id="btnNew"><span class="icon">âŸ³</span>æ–°æ¸¸æˆ</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-emoji">ğŸ‰</div>
    <h2 id="modalTitle">æ­å–œå®Œæˆï¼</h2>
    <p id="modalMsg">ç”¨æ—¶ 00:00ï¼Œé›¶é”™è¯¯å®Œæˆï¼</p>
    <button class="modal-btn" id="modalBtn">å†æ¥ä¸€å±€</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const html = document.documentElement;
const sysDark = window.matchMedia('(prefers-color-scheme: dark)');
let currentThemeMode = 'system';

function applyTheme(mode) {
  currentThemeMode = mode;
  html.dataset.theme = (mode === 'system') ? (sysDark.matches ? 'dark' : 'light') : mode;
  document.querySelectorAll('.theme-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.mode === mode)
  );
  try { localStorage.setItem('sudoku_theme', mode); } catch(e) {}
}

sysDark.addEventListener('change', () => {
  if (currentThemeMode === 'system') applyTheme('system');
});

document.querySelectorAll('.theme-btn').forEach(btn =>
  btn.addEventListener('click', () => applyTheme(btn.dataset.mode))
);

// Init theme before render to avoid flash
(function() {
  try {
    const t = localStorage.getItem('sudoku_theme') || 'system';
    // Apply immediately without transition
    html.dataset.theme = (t === 'system') ? (sysDark.matches ? 'dark' : 'light') : t;
    currentThemeMode = t;
  } catch(e) {}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OFFLINE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const offlineBar = document.getElementById('offlineBar');
function updateOnlineStatus() {
  offlineBar.classList.toggle('show', !navigator.onLine);
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// Pre-cache this page in the Cache API for offline reload
if ('caches' in window) {
  window.addEventListener('load', async () => {
    try {
      const cache = await caches.open('sudoku-offline-v1');
      const pageUrl = location.href.split('?')[0];
      if (!await cache.match(pageUrl)) await cache.add(pageUrl);
    } catch(e) {}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTOSAVE TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const saveToast = document.getElementById('saveToast');
let toastTimer = null;
function showSaveToast() {
  saveToast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => saveToast.classList.remove('show'), 1800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUDOKU ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffleArray(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
}

function isValid(board, row, col, num) {
  for (let i = 0; i < 9; i++) {
    if (board[row][i] === num || board[i][col] === num) return false;
  }
  const br = Math.floor(row/3)*3, bc = Math.floor(col/3)*3;
  for (let r = 0; r < 3; r++)
    for (let c = 0; c < 3; c++)
      if (board[br+r][bc+c] === num) return false;
  return true;
}

function solveSudoku(board, randomize=false) {
  for (let row = 0; row < 9; row++) {
    for (let col = 0; col < 9; col++) {
      if (board[row][col] === 0) {
        let nums = [1,2,3,4,5,6,7,8,9];
        if (randomize) shuffleArray(nums);
        for (const num of nums) {
          if (isValid(board, row, col, num)) {
            board[row][col] = num;
            if (solveSudoku(board, randomize)) return true;
            board[row][col] = 0;
          }
        }
        return false;
      }
    }
  }
  return true;
}

function generateSudoku(difficulty) {
  const removeCounts = {easy:35, medium:45, hard:52, expert:58};
  const board = Array.from({length:9}, () => Array(9).fill(0));
  solveSudoku(board, true);
  const solution = board.map(r => [...r]);
  const puzzle = board.map(r => [...r]);
  const positions = [...Array(81).keys()];
  shuffleArray(positions);
  let toRemove = removeCounts[difficulty] || 45;
  for (let i = 0; i < positions.length && toRemove > 0; i++) {
    puzzle[Math.floor(positions[i]/9)][positions[i]%9] = 0;
    toRemove--;
  }
  return {puzzle, solution};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let puzzle, solution, userGrid, notes;
let selectedCell = null;
let noteMode = false;
let mistakes = 0;
let timerInterval = null;
let seconds = 0;
let difficulty = 'medium';
let history = [];
let hintsLeft = 3;
let gameOver = false;

function saveState() {
  try {
    localStorage.setItem('sudoku_save', JSON.stringify({
      puzzle, solution, userGrid,
      notes: notes.map(row => row.map(s => [...s])),
      mistakes, seconds, difficulty, hintsLeft, gameOver
    }));
    showSaveToast();
  } catch(e) {}
}

function loadState() {
  try {
    const raw = localStorage.getItem('sudoku_save');
    if (!raw) return false;
    const d = JSON.parse(raw);
    puzzle=d.puzzle; solution=d.solution; userGrid=d.userGrid;
    notes=d.notes.map(row=>row.map(arr=>new Set(arr)));
    mistakes=d.mistakes; seconds=d.seconds; difficulty=d.difficulty;
    hintsLeft=d.hintsLeft; gameOver=d.gameOver;
    return true;
  } catch(e) { return false; }
}

function newGame(diff=difficulty) {
  difficulty=diff; gameOver=false; mistakes=0; seconds=0;
  hintsLeft=3; noteMode=false; history=[]; selectedCell=null;
  const r = generateSudoku(difficulty);
  puzzle=r.puzzle; solution=r.solution;
  userGrid=puzzle.map(row=>[...row]);
  notes=Array.from({length:9},()=>Array.from({length:9},()=>new Set()));
  renderBoard(); renderNumpad();
  updateTimer(); updateMistakeDots(); updateProgress(); syncDiffBtns();
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{ seconds++; updateTimer(); }, 1000);
  document.getElementById('btnNote').classList.remove('active');
  document.getElementById('btnHint').querySelector('.icon').textContent='ğŸ’¡';
  saveState();
}

function resumeGame() {
  renderBoard(); renderNumpad();
  updateTimer(); updateMistakeDots(); updateProgress(); syncDiffBtns();
  if (!gameOver) {
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{ seconds++; updateTimer(); }, 1000);
  }
  // Restore hint icon
  document.getElementById('btnHint').querySelector('.icon').textContent = `ğŸ’¡${hintsLeft<3&&hintsLeft>0?hintsLeft:''}`;
}

function syncDiffBtns() {
  document.querySelectorAll('.diff-btn').forEach(b=>
    b.classList.toggle('active', b.dataset.level===difficulty)
  );
}

function updateTimer() {
  const m=String(Math.floor(seconds/60)).padStart(2,'0');
  const s=String(seconds%60).padStart(2,'0');
  document.getElementById('timer').textContent=`${m}:${s}`;
}

function updateMistakeDots() {
  document.querySelectorAll('.mistake-dot').forEach((d,i)=>
    d.classList.toggle('active', i<mistakes)
  );
}

function updateProgress() {
  let filled=0;
  for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(userGrid[r][c]!==0) filled++;
  document.getElementById('progressFill').style.width = Math.round(filled/81*100)+'%';
}

// â”€â”€â”€ Board Rendering â”€â”€â”€
function renderBoard() {
  const board=document.getElementById('board');
  board.innerHTML='';
  for(let r=0;r<9;r++) {
    for(let c=0;c<9;c++) {
      const cell=document.createElement('div');
      cell.className='cell'; cell.dataset.row=r; cell.dataset.col=c;
      const valDiv=document.createElement('div'); valDiv.className='cell-val';
      const ng=document.createElement('div'); ng.className='notes-grid';
      for(let n=1;n<=9;n++) {
        const nd=document.createElement('div');
        nd.className='note-num'; nd.dataset.note=n;
        ng.appendChild(nd);
      }
      cell.appendChild(valDiv); cell.appendChild(ng);
      cell.addEventListener('click',()=>selectCell(r,c));
      board.appendChild(cell);
    }
  }
  refreshAllCells();
}

function getCellEl(r,c) {
  return document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
}

function refreshCell(r,c) {
  const cell=getCellEl(r,c); if(!cell) return;
  const val=userGrid[r][c], isGiven=puzzle[r][c]!==0, cellNotes=notes[r][c];
  cell.className='cell';
  if(isGiven) cell.classList.add('given');
  else if(val!==0) { cell.classList.add('user-input'); if(val!==solution[r][c]) cell.classList.add('error'); }
  cell.querySelector('.cell-val').textContent = val!==0 ? val : '';
  if(!isGiven && val===0 && cellNotes.size>0) {
    cell.classList.add('has-notes');
    cell.querySelectorAll('.note-num').forEach(nd=>{
      const n=parseInt(nd.dataset.note);
      nd.textContent=cellNotes.has(n)?n:'';
      nd.classList.toggle('filled', cellNotes.has(n));
    });
  } else {
    cell.querySelectorAll('.note-num').forEach(nd=>nd.textContent='');
  }
}

function refreshAllCells() {
  for(let r=0;r<9;r++) for(let c=0;c<9;c++) refreshCell(r,c);
  if(selectedCell) highlightRelated(selectedCell[0],selectedCell[1]);
}

function highlightRelated(row,col) {
  document.querySelectorAll('.cell').forEach(c=>
    c.classList.remove('selected','highlighted','same-number')
  );
  const val=userGrid[row][col];
  const br=Math.floor(row/3)*3, bc=Math.floor(col/3)*3;
  for(let i=0;i<9;i++) {
    getCellEl(row,i)?.classList.add('highlighted');
    getCellEl(i,col)?.classList.add('highlighted');
  }
  for(let r=0;r<3;r++) for(let c=0;c<3;c++) getCellEl(br+r,bc+c)?.classList.add('highlighted');
  if(val!==0) for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(userGrid[r][c]===val) getCellEl(r,c)?.classList.add('same-number');
  getCellEl(row,col)?.classList.add('selected');
}

function selectCell(r,c) { selectedCell=[r,c]; highlightRelated(r,c); }

function inputNumber(num) {
  if(!selectedCell||gameOver) return;
  const [r,c]=selectedCell;
  if(puzzle[r][c]!==0) return;
  if(noteMode) {
    history.push({type:'note',r,c,notes:new Set(notes[r][c])});
    if(notes[r][c].has(num)) notes[r][c].delete(num); else notes[r][c].add(num);
    refreshCell(r,c); saveState(); return;
  }
  history.push({type:'val',r,c,prev:userGrid[r][c]});
  userGrid[r][c]=num;
  if(num!==solution[r][c]) {
    mistakes++; updateMistakeDots();
    if(mistakes>=3) { refreshCell(r,c); showGameOver(); return; }
  } else {
    clearRelatedNotes(r,c,num);
    const el=getCellEl(r,c);
    el.classList.add('just-correct');
    setTimeout(()=>el.classList.remove('just-correct'),400);
  }
  refreshCell(r,c); updateProgress(); highlightRelated(r,c); renderNumpad(); saveState(); checkWin();
}

function clearRelatedNotes(row,col,num) {
  const br=Math.floor(row/3)*3, bc=Math.floor(col/3)*3;
  for(let i=0;i<9;i++) {
    notes[row][i].delete(num); notes[i][col].delete(num);
    refreshCell(row,i); refreshCell(i,col);
  }
  for(let r=0;r<3;r++) for(let c=0;c<3;c++) { notes[br+r][bc+c].delete(num); refreshCell(br+r,bc+c); }
}

function eraseCell() {
  if(!selectedCell||gameOver) return;
  const [r,c]=selectedCell; if(puzzle[r][c]!==0) return;
  history.push({type:'val',r,c,prev:userGrid[r][c]});
  userGrid[r][c]=0; notes[r][c].clear();
  refreshCell(r,c); updateProgress(); renderNumpad(); highlightRelated(r,c); saveState();
}

function undo() {
  if(!history.length||gameOver) return;
  const last=history.pop();
  if(last.type==='val') userGrid[last.r][last.c]=last.prev;
  else notes[last.r][last.c]=last.notes;
  refreshAllCells(); renderNumpad(); updateProgress(); saveState();
}

function useHint() {
  if(hintsLeft<=0||gameOver) return;
  if(!selectedCell) { for(let i=0;i<81;i++){const row=Math.floor(i/9),col=i%9; if(userGrid[row][col]===0){selectCell(row,col);break;}} }
  if(!selectedCell) return;
  let [hr,hc]=selectedCell;
  if(puzzle[hr][hc]!==0||userGrid[hr][hc]===solution[hr][hc]) {
    for(let i=0;i<81;i++){const row=Math.floor(i/9),col=i%9; if(userGrid[row][col]===0){selectCell(row,col);[hr,hc]=[row,col];break;}}
  }
  hintsLeft--;
  history.push({type:'val',r:hr,c:hc,prev:userGrid[hr][hc]});
  userGrid[hr][hc]=solution[hr][hc]; notes[hr][hc].clear();
  refreshAllCells(); updateProgress(); renderNumpad(); highlightRelated(hr,hc);
  document.getElementById('btnHint').querySelector('.icon').textContent=`ğŸ’¡${hintsLeft||''}`;
  saveState(); checkWin();
}

function checkWin() {
  for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(userGrid[r][c]!==solution[r][c]) return;
  clearInterval(timerInterval); gameOver=true; saveState();
  setTimeout(showWin,600);
}

function showWin() {
  const m=String(Math.floor(seconds/60)).padStart(2,'0');
  const s=String(seconds%60).padStart(2,'0');
  document.getElementById('overlay').querySelector('.modal-emoji').textContent='ğŸ‰';
  document.getElementById('modalTitle').textContent='æ­å–œå®Œæˆï¼';
  document.getElementById('modalMsg').textContent=`ç”¨æ—¶ ${m}:${s}ï¼Œé”™è¯¯ ${mistakes} æ¬¡å®Œæˆï¼`;
  document.getElementById('overlay').classList.add('show');
}

function showGameOver() {
  clearInterval(timerInterval); gameOver=true; saveState();
  setTimeout(()=>{
    document.getElementById('overlay').querySelector('.modal-emoji').textContent='ğŸ˜”';
    document.getElementById('modalTitle').textContent='æ¸¸æˆç»“æŸ';
    document.getElementById('modalMsg').textContent='é”™è¯¯æ¬¡æ•°å¤ªå¤šï¼Œå·²è¶…å‡ºé™åˆ¶ã€‚';
    document.getElementById('overlay').classList.add('show');
  },400);
}

function renderNumpad() {
  const numpad=document.getElementById('numpad'); numpad.innerHTML='';
  const counts=Array(10).fill(0);
  for(let r=0;r<9;r++) for(let c=0;c<9;c++) if(userGrid[r][c]>0&&userGrid[r][c]===solution[r][c]) counts[userGrid[r][c]]++;
  for(let n=1;n<=9;n++) {
    const btn=document.createElement('button'); btn.className='num-btn';
    btn.innerHTML=`${n}<span class="num-count">${9-counts[n]>0?9-counts[n]:''}</span>`;
    if(counts[n]>=9) btn.classList.add('depleted');
    btn.addEventListener('click',()=>inputNumber(n));
    numpad.appendChild(btn);
  }
}

function toggleNote() {
  noteMode=!noteMode;
  document.getElementById('btnNote').classList.toggle('active',noteMode);
}

// â”€â”€â”€ Keyboard â”€â”€â”€
document.addEventListener('keydown', e => {
  if(e.key>='1'&&e.key<='9') inputNumber(parseInt(e.key));
  else if(e.key==='Backspace'||e.key==='Delete') eraseCell();
  else if(e.key==='z'&&(e.ctrlKey||e.metaKey)){e.preventDefault();undo();}
  else if(e.key==='n') toggleNote();
  else if(selectedCell) {
    const [r,c]=selectedCell;
    const dirs={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1]};
    if(dirs[e.key]){
      e.preventDefault();
      const [dr,dc]=dirs[e.key];
      selectCell(Math.max(0,Math.min(8,r+dr)),Math.max(0,Math.min(8,c+dc)));
    }
  }
});

document.querySelectorAll('.diff-btn').forEach(btn=>btn.addEventListener('click',()=>newGame(btn.dataset.level)));
document.getElementById('btnUndo').addEventListener('click',undo);
document.getElementById('btnErase').addEventListener('click',eraseCell);
document.getElementById('btnNote').addEventListener('click',toggleNote);
document.getElementById('btnHint').addEventListener('click',useHint);
document.getElementById('btnNew').addEventListener('click',()=>newGame());
document.getElementById('modalBtn').addEventListener('click',()=>{
  document.getElementById('overlay').classList.remove('show');
  newGame();
});

// â”€â”€â”€ Init theme buttons (after DOM ready) â”€â”€â”€
applyTheme(currentThemeMode);

// â”€â”€â”€ Start â”€â”€â”€
if(loadState()) { resumeGame(); } else { newGame(); }
</script>
</body>
</html>
